{% extends "base.html" %}
{% load static %}

{% block title %}Inspiration Ideas{% endblock %}

{% block content %}
<section class="py-12 lg:px-12 md:py-16 bg-neutral-50 min-h-[1000px]">
  <div class="container mx-auto px-4">

    <div class="text-center mb-12">
      <h1 class="text-3xl md:text-4xl font-bold text-primary-900 mb-4">
        Inspiration Gallery
      </h1>
      <p class="text-lg text-gray-600 max-w-2xl mx-auto">
        Discover paint ideas for every room. Find your next project, save your favorite looks, and shop the colors.
      </p>
    </div>

    <form id="filters-form" method="get" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-12">
      {% csrf_token %} <div>
        <label for="category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
        <div class="relative filter-select-wrapper">
          <select id="category" name="category" class="pl-4 pr-10 py-2 w-full border rounded text-sm text-primary-900 bg-white focus:outline-none focus:border-primary-500 appearance-none">
            <option value="">All Categories</option>
            {% for c in categories %}
            <option value="{{ c.slug }}" {% if c.slug == selected_category %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
          </select>
          <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
            <svg class="w-5 h-5 text-primary-900 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 8l4 4 4-4"/>
            </svg>
          </div>
        </div>
      </div>

      <div>
        <label for="tag" class="block text-sm font-medium text-gray-700 mb-1">Tag</label>
        <div class="relative filter-select-wrapper">
          <select id="tag" name="tag" class="pl-4 pr-10 py-2 w-full border rounded text-sm text-primary-900 bg-white focus:outline-none focus:border-primary-500 appearance-none">
            <option value="">All Tags</option>
            {% for t in tags %}
            <option value="{{ t.slug }}" {% if t.slug == selected_tag %}selected{% endif %}>{{ t.name }}</option>
            {% endfor %}
          </select>
          <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none">
            <svg class="w-5 h-5 text-primary-900 transition-transform duration-200" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
              <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 8l4 4 4-4"/>
            </svg>
          </div>
        </div>
      </div>

      <div>
        <label for="q" class="block text-sm font-medium text-gray-700 mb-1">Search</label>
        <input type="text" id="q" name="q" value="{{ search_query|default:'' }}" placeholder="Search by title, tag..." class="w-full px-4 py-2 border rounded text-sm focus:outline-none focus:border-primary-500">
      </div>

      <div class="self-end">
        <button type="submit" class="w-full px-6 py-2 bg-primary-900 text-white rounded text-sm font-medium hover:bg-primary-700 transition-colors">
          Apply Filters
        </button>
      </div>
    </form>

    <div id="ideas-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
      {% for idea in ideas %}
        <div class="group bg-white rounded border border-neutral-200 hover:shadow transition-all relative flex flex-col">
          <div class="relative">
            <a href="{{ idea.get_absolute_url }}">
                {% if idea.get_display_image %}
                    <img src="{{ idea.get_display_image }}" alt="{{ idea.title }}" class="w-full h-64 object-cover">
                {% else %}
                    <img src="{{ MEDIA_URL }}default.jpg" alt="{{ idea.title }}" class="w-full h-64 object-cover">
                {% endif %}
            </a>

            {% if user.is_authenticated %}
            <button
              class="save-idea-btn absolute top-3 right-3 p-2 bg-white/90 backdrop-blur-sm rounded-full shadow-sm text-neutral-400 hover:text-red-500 hover:bg-red-50 transition-all z-10"
              data-idea-id="{{ idea.id }}"
              data-is-saved="{{ idea.is_saved|yesno:'true,false' }}"
              aria-label="Save inspiration idea"
            >
              <span class="heart-icon block">
                {% if idea.is_saved %}
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="red" stroke="red" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                {% else %}
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                {% endif %}
              </span>
            </button>
          {% endif %}
          </div>

          <div class="p-5 flex flex-col flex-grow">
            <a href="{{ idea.get_absolute_url }}" class="block text-xl font-semibold text-primary-900 hover:underline mb-2">{{ idea.title }}</a>
            <p class="text-gray-600 text-sm mb-3">
              {{ idea.description|truncatewords:20 }}
            </p>
            <div class="flex flex-wrap gap-2 mt-auto pt-4">
              {% for tag in idea.tags.all %}
                <span class="inline-block px-3 py-1 rounded-full text-xs font-medium bg-neutral-100 text-neutral-800">
                  {{ tag.name }}
                </span>
              {% endfor %}
            </div>
          </div>
        </div>
      {% empty %}
        {# --- Empty State Logic for Ideas --- #}
        {% if ideas|length == 0 and not search_query and not selected_category and not selected_tag %}
          {# No ideas in the database (initial state) #}
          <div class="col-span-full py-12 flex justify-center items-center h-full">
            <div id="ideas-empty-state-initial" class="text-center py-8 px-12 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 max-w-lg mx-auto">
              <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 mx-auto text-gray-400 mb-3 lucide lucide-sparkles"><path d="M9.9 10.9L17.7 3.1"/><path d="M12.7 20.7L10.9 22.5"/><path d="M16 8l3 3"/><path d="M15 15l2 2"/><path d="M12 2v2"/><path d="M4 12H2"/><path d="M20 12h2"/><path d="M6 6L4 4"/></svg>
              <h3 class="text-xl font-semibold text-primary-900 mb-2">No Inspiration Yet</h3>
              <p class="text-gray-600">
                It looks like our gallery is currently under construction. Please check back soon for new inspiration!
              </p>
            </div>
          </div>
        {% else %}
          {# No results found due to search or filter criteria #}
          <div class="col-span-full py-12">
            <div id="ideas-empty-state-filter" class="text-center py-8 px-12 border-2 border-dashed border-gray-300 rounded-xl bg-gray-50 max-w-xl mx-auto">
              <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-10 h-10 mx-auto text-gray-400 mb-3 lucide lucide-frown"><path d="M16 16s-1.5-2-4-2-4 2-4 2"/><circle cx="12" cy="12" r="10"/><path d="M15 9.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0"/><path d="M9 9.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0"/></svg>
              <h3 class="text-xl font-semibold text-primary-900 mb-2">Nothing Matches Your Search</h3>
              <p class="text-gray-600">
                We couldn't find any ideas matching your **filters** or **search query**.
                Try broadening your criteria or selecting **All Categories**.
              </p>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    </div>

  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const saveToggleUrl = "{% url 'save_idea_toggle' %}";
  const ideasGrid = document.getElementById('ideas-grid');

  // Helper to get the CSRF token from the form
  function getCsrfToken() {
    const csrfInput = document.querySelector('form [name="csrfmiddlewaretoken"]');
    return csrfInput ? csrfInput.value : '';
  }

  // --- AJAX SAVE/UNSAVE IDEA (Event Delegation) ---
  if (ideasGrid) {
    ideasGrid.addEventListener('click', async (e) => {
      const button = e.target.closest('.save-idea-btn');
      if (!button) return;

      e.preventDefault();
      const ideaId = button.dataset.ideaId;
      if (!ideaId) return;

      button.disabled = true;

      try {
        const response = await fetch(saveToggleUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCsrfToken()
          },
          body: `idea_id=${ideaId}`
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.json();

        if (data.status === 'success') {
          const heartIcon = button.querySelector('.heart-icon');
          const svgElement = heartIcon.querySelector('svg');

          if (svgElement) {
            if (data.is_saved) {
              svgElement.setAttribute('fill', 'red');
              svgElement.setAttribute('stroke', 'red');
              button.dataset.isSaved = 'true';
            } else {
              svgElement.setAttribute('fill', 'none');
              svgElement.setAttribute('stroke', 'currentColor');
              button.dataset.isSaved = 'false';
            }
          }
        }
      } catch (error) {
        console.error('Failed to toggle save:', error);
      } finally {
        button.disabled = false;
      }
    });
  }

  // --- ANIMATE SELECT ARROWS ---
  document.querySelectorAll('.filter-select-wrapper').forEach(wrapper => {
    const select = wrapper.querySelector('select');
    const svg = wrapper.querySelector('svg');

    if (select && svg) {
      select.addEventListener('focus', () => {
        svg.classList.add('rotate-180');
      });
      select.addEventListener('blur', () => {
        svg.classList.remove('rotate-180');
      });
    }
  });

});
</script>
{% endblock %}