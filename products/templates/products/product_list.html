{% extends "base.html" %}
{% load static %}

{% block title %}Products{% endblock %}

{% block content %}
<section class="py-12 lg:px-12 bg-neutral-50 min-h-[1000px]">
  <div class="container mx-auto px-4 max-w-7xl">

    {# --- HEADER & SEARCH --- #}
    <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-8 gap-4">
      <h1 class="text-2xl md:text-3xl font-bold text-primary-900 text-center md:text-left">
        Our Products
      </h1>

      <form id="search-form" method="get" class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
        <input type="hidden" name="category" value="{{ selected_category|default:'' }}">
        <input type="hidden" name="subcategory" value="{{ selected_subcategory|default:'' }}">

        <input
          type="text"
          name="q"
          placeholder="Search products..."
          value="{{ query|default:'' }}"
          class="px-4 py-2 border rounded text-sm w-full sm:w-64"
        >
        <button
          type="submit"
          class="bg-primary-900 text-white px-4 py-2 rounded hover:bg-primary-900/80 transition-colors"
        >
          Search
        </button>
      </form>
    </div>

    {# --- FILTERS CONTAINER --- #}
    <div id="filters-container">
        {# --- TIER 1 FILTER: Main Categories --- #}
        <div class="flex flex-wrap gap-2 sm:gap-4 mb-4 justify-center md:justify-start">
          <a
            href="{% url 'product_list' %}{% if query %}?q={{ query }}{% endif %}"
            class="filter-link tier1-link px-4 py-2 rounded-full border {% if not selected_category %}bg-primary-900 text-white{% else %}text-primary-900 bg-white{% endif %} hover:bg-primary-900 hover:text-white transition-colors"
            data-category=""
          >
            All Products
          </a>

          {% for cat in categories %}
            <a
              href="?category={{ cat.slug }}{% if query %}&q={{ query }}{% endif %}"
              class="filter-link tier1-link px-4 py-2 rounded-full border {% if cat.slug == selected_category %}bg-primary-900 text-white{% else %}text-primary-900 bg-white{% endif %} hover:bg-primary-900 hover:text-white transition-colors"
              data-category="{{ cat.slug }}"
            >
              {{ cat.name }}
            </a>
          {% endfor %}
        </div>

        {# --- TIER 2 FILTER: Subcategories --- #}
        {% for cat in categories %}
            {% if cat.subcategories.all %}
            {# FIX: Added explicit check. Only show if this cat IS the selected one. #}
            <div id="tier2-{{ cat.slug }}"
                 class="tier2-block flex-wrap items-center gap-2 mb-8 justify-center md:justify-start bg-neutral-100 p-3 rounded-lg md:rounded-full {% if cat.slug == selected_category %}flex md:inline-flex{% else %}hidden{% endif %}">
                <span class="text-sm text-neutral-500 font-medium px-2">Filter {{ cat.name }}:</span>

                <a
                href="?category={{ cat.slug }}{% if query %}&q={{ query }}{% endif %}"
                class="filter-link tier2-link text-sm px-3 py-1 rounded-full border {% if cat.slug == selected_category and not selected_subcategory %}bg-neutral-700 text-white border-neutral-700{% else %}text-neutral-700 border-neutral-300 bg-white{% endif %} hover:bg-neutral-700 hover:text-white transition-colors"
                data-category="{{ cat.slug }}"
                data-subcategory=""
                >
                All
                </a>

                {% for sub in cat.subcategories.all %}
                <a
                    href="?category={{ cat.slug }}&subcategory={{ sub.slug }}{% if query %}&q={{ query }}{% endif %}"
                    class="filter-link tier2-link text-sm px-3 py-1 rounded-full border {% if sub.slug == selected_subcategory %}bg-neutral-700 text-white border-neutral-700{% else %}text-neutral-700 border-neutral-300 bg-white{% endif %} hover:bg-neutral-700 hover:text-white transition-colors"
                    data-category="{{ cat.slug }}"
                    data-subcategory="{{ sub.slug }}"
                >
                    {{ sub.name }}
                </a>
                {% endfor %}
            </div>
            {% endif %}
        {% endfor %}
    </div>

    {# --- PRODUCT GRID CONTAINER --- #}
    <div class="relative min-h-[400px]">
        <div id="grid-loader" class="absolute inset-0 z-10 bg-neutral-50/80 backdrop-blur-[1px] hidden transition-opacity duration-200 opacity-0 flex items-start justify-center pt-20">
            <div class="animate-spin rounded-full h-10 w-10 border-t-2 border-b-2 border-primary-900"></div>
        </div>

        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4 {% if not selected_category %}mt-8{% endif %}" id="products-grid">
          {% for product in products %}
          <div class="group bg-white rounded border border-neutral-200 hover:shadow transition-all relative flex flex-col">
            <div class="h-48 bg-neutral-100 relative flex items-center justify-center rounded-t overflow-hidden">
              {% if product.main_image %}
                <img src="{{ product.main_image.url }}" alt="{{ product.name }}" class="object-contain p-4 w-full h-full mix-blend-multiply">
              {% else %}
                 <div class="text-neutral-300 flex flex-col items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span class="text-xs">No image</span>
                 </div>
              {% endif %}
                {% if user.is_authenticated %}
                  <button
                    class="save-product-btn absolute top-3 right-3 text-neutral-400 hover:text-red-500 z-10 bg-white rounded-full p-1 shadow-sm transition-all"
                    data-product-id="{{ product.id }}"
                    data-is-saved="{{ product.is_saved|yesno:'true,false' }}"
                    aria-label="Save product"
                  >
                    <span class="heart-icon">
                      {% if product.is_saved %}
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="red" stroke="red">
                          <path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037.033l.034-.03a6 6 0 0 1 4.733-1.44l.246.036a6 6 0 0 1 3.364 10.008l-.18.185l-.048.041l-7.45 7.379a1 1 0 0 1-1.313.082l-.094-.082l-7.493-7.422A6 6 0 0 1 6.979 3.074"/>
                        </svg>
                      {% else %}
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                        </svg>
                      {% endif %}
                    </span>
                  </button>
                {% endif %}
            </div>
            <div class="p-5 flex flex-col flex-grow">
              <div class="mb-2">
                 <span class="text-xs font-semibold uppercase tracking-wider text-primary-700 bg-primary-50 px-2 py-1 rounded">
                     {{ product.subcategory.name|default:product.category.name }}
                 </span>
              </div>
              <h3 class="text-xl font-semibold mb-2 text-primary-900">
                <a href="{{ product.get_absolute_url }}">{{ product.name }}</a>
              </h3>
              <p class="text-base text-neutral-600 mb-4 line-clamp-2 flex-grow">{{ product.description|striptags|truncatewords:15 }}</p>
              <div class="flex justify-between items-center mt-auto">
                 <span class="text-sm text-neutral-500">{{ product.category.name }}</span>
                 <a href="{{ product.get_absolute_url }}" class="px-4 py-2 text-sm text-white font-medium rounded bg-primary-900 hover:bg-primary-500">
                  View
                </a>
              </div>
            </div>
          </div>
          {% empty %}
            <div class="col-span-full py-12 flex justify-center items-center">
                {% if not query and not selected_category %}
                  <div class="text-center py-8 px-12 border-2 border-dashed border-neutral-300 rounded-xl bg-neutral-100 max-w-lg mx-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 mx-auto text-neutral-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                    <h3 class="text-xl font-semibold text-primary-900 mb-2">Catalog Empty</h3>
                    <p class="text-neutral-500">Check back soon for our new range of products.</p>
                  </div>
                {% else %}
                  <div class="text-center py-8 px-12 border-2 border-dashed border-neutral-300 rounded-xl bg-white max-w-xl mx-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 mx-auto text-neutral-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h3 class="text-lg font-semibold text-neutral-900 mb-1">No products found</h3>
                    <p class="text-neutral-600">
                      We couldn't find anything matching your filters. Try clearing them or searching for something else.
                    </p>
                    <a href="{% url 'product_list' %}" class="mt-4 inline-block px-6 py-2 bg-primary-900 text-white rounded hover:bg-primary-800 transition-colors">
                        Clear Filters
                    </a>
                  </div>
                {% endif %}
            </div>
          {% endfor %}
        </div>
    </div>
  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]')?.value || '{{ csrf_token }}';
  const gridContainer = document.getElementById('products-grid');
  const filtersContainer = document.getElementById('filters-container');
  const loader = document.getElementById('grid-loader');
  const searchForm = document.getElementById('search-form');

  if (typeof lucide !== 'undefined') lucide.createIcons();

  // --- AJAX FILTERING ---
  if (filtersContainer) {
      filtersContainer.addEventListener('click', async (e) => {
          const link = e.target.closest('.filter-link');
          if (!link) return;
          e.preventDefault();
          const url = link.href;
          window.history.pushState({}, '', url);
          await fetchProducts(url);
      });
  }

  if (searchForm) {
      searchForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const url = `${window.location.pathname}?${new URLSearchParams(new FormData(searchForm)).toString()}`;
          window.history.pushState({}, '', url);
          await fetchProducts(url);
      });
  }

  window.addEventListener('popstate', () => fetchProducts(window.location.href));

  async function fetchProducts(url) {
      loader.classList.remove('hidden');
      requestAnimationFrame(() => loader.classList.add('opacity-100'));

      try {
          const res = await fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
          if (!res.ok) throw new Error('Network error');
          const data = await res.json();

          renderGrid(data.products);
          updateFilters(url);
          const urlObj = new URL(url, window.location.origin);
          searchForm.querySelector('[name="category"]').value = urlObj.searchParams.get('category') || '';
          searchForm.querySelector('[name="subcategory"]').value = urlObj.searchParams.get('subcategory') || '';

      } catch (err) { console.error(err); }
      finally {
          loader.classList.remove('opacity-100');
          setTimeout(() => loader.classList.add('hidden'), 200);
      }
  }

  function renderGrid(products) {
      const urlParams = new URLSearchParams(window.location.search);
      const hasCategory = urlParams.get('category');
      if (hasCategory) {
          gridContainer.classList.remove('mt-8');
      } else {
          gridContainer.classList.add('mt-8');
      }

      if (products.length === 0) {
           gridContainer.innerHTML = `
            <div class="col-span-full py-12 flex justify-center items-center">
                <div class="text-center py-8 px-12 border-2 border-dashed border-neutral-300 rounded-xl bg-white max-w-xl mx-auto">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10 mx-auto text-neutral-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                  <h3 class="text-lg font-semibold text-neutral-900 mb-1">No products found</h3>
                  <p class="text-neutral-600">We couldn't find anything matching your filters.</p>
                  <a href="${window.location.pathname}" class="mt-4 inline-block px-6 py-2 bg-primary-900 text-white rounded hover:bg-primary-800 transition-colors">Clear Filters</a>
                </div>
            </div>`;
           if (typeof lucide !== 'undefined') lucide.createIcons();
           return;
      }

      gridContainer.innerHTML = products.map(p => {
          const imgHtml = p.main_image_url
              ? `<img src="${p.main_image_url}" alt="${p.name}" class="object-contain p-4 w-full h-full mix-blend-multiply">`
              : `<div class="text-neutral-300 flex flex-col items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg><span class="text-xs">No image</span></div>`;

          const heartSaved = `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="red" stroke="red"><path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037.033l.034-.03a6 6 0 0 1 4.733-1.44l.246.036a6 6 0 0 1 3.364 10.008l-.18.185l-.048.041l-7.45 7.379a1 1 0 0 1-1.313.082l-.094-.082l-7.493-7.422A6 6 0 0 1 6.979 3.074"/></svg>`;
          const heartUnsaved = `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>`;

          return `
          <div class="group bg-white rounded border border-neutral-200 hover:shadow transition-all relative flex flex-col">
            <div class="h-48 bg-neutral-100 relative flex items-center justify-center rounded-t overflow-hidden">
              ${imgHtml}
              <button class="save-product-btn absolute top-3 right-3 text-neutral-400 hover:text-red-500 z-10 bg-white rounded-full p-1 shadow-sm transition-all"
                      data-product-id="${p.id}" data-is-saved="${p.is_saved ? 'true' : 'false'}">
                <span class="heart-icon">${p.is_saved ? heartSaved : heartUnsaved}</span>
              </button>
            </div>
            <div class="p-5 flex flex-col flex-grow">
              <div class="mb-2">
                 <span class="text-xs font-semibold uppercase tracking-wider text-primary-700 bg-primary-50 px-2 py-1 rounded">
                     ${p.subcategory_name || p.category_name}
                 </span>
              </div>
              <h3 class="text-xl font-semibold mb-2 text-primary-900">
                <a href="${p.url}">${p.name}</a>
              </h3>
              <p class="text-base text-neutral-600 mb-4 line-clamp-2 flex-grow">${p.description_excerpt}</p>
              <div class="flex justify-between items-center mt-auto">
                 <span class="text-sm text-neutral-500">${p.category_name}</span>
                 <a href="${p.url}" class="px-4 py-2 text-sm text-white font-medium rounded bg-primary-900 hover:bg-primary-500">View</a>
              </div>
            </div>
          </div>`;
      }).join('');
  }

  function updateFilters(urlStr) {
      const url = new URL(urlStr, window.location.origin);
      const cat = url.searchParams.get('category') || '';
      const sub = url.searchParams.get('subcategory') || '';

      // 1. Manage Tier 2 Visibility: Hide ALL first, then show ONLY the one matching current category
      document.querySelectorAll('.tier2-block').forEach(block => {
          block.classList.remove('flex', 'md:inline-flex');
          block.classList.add('hidden');
      });

      if (cat) {
          const activeTier2 = document.getElementById(`tier2-${cat}`);
          if (activeTier2) {
              activeTier2.classList.remove('hidden');
              activeTier2.classList.add('flex', 'md:inline-flex');
          }
      }

      // 2. Update active states for ALL filter links
      document.querySelectorAll('.filter-link').forEach(link => {
          const lCat = link.dataset.category;
          const lSub = link.dataset.subcategory;
          const isTier2 = link.classList.contains('tier2-link');
          const isActive = isTier2 ? (lCat === cat && lSub === sub) : (lCat === cat && !sub);

          if (isActive) {
              link.classList.remove('text-primary-900', 'bg-white');
              link.classList.remove('bg-neutral-700', 'text-white', 'border-neutral-700');
              if (isTier2) {
                   link.classList.add('bg-neutral-700', 'text-white', 'border-neutral-700');
              } else {
                   link.classList.add('bg-primary-900', 'text-white');
              }
          } else {
              link.classList.remove('bg-primary-900', 'text-white');
              link.classList.remove('bg-neutral-700', 'border-neutral-700');
              if (isTier2) {
                  link.classList.add('text-neutral-700', 'border-neutral-300', 'bg-white');
              } else {
                  link.classList.add('text-primary-900', 'bg-white');
              }
          }
      });
  }

  // --- SAVE TOGGLE ---
  if (gridContainer) {
    gridContainer.addEventListener('click', async (e) => {
      const button = e.target.closest('.save-product-btn');
      if (!button) return;
      e.preventDefault();
      const productId = button.dataset.productId;
      button.disabled = true;
      try {
        const res = await fetch("{% url 'save_product_toggle' %}", {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': csrfToken },
          body: `product_id=${productId}`
        });
        const data = await res.json();
        if (data.status === 'success') {
           const svgContainer = button.querySelector('.heart-icon');
           if (data.is_saved) {
             svgContainer.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="red" stroke="red"><path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037.033l.034-.03a6 6 0 0 1 4.733-1.44l.246.036a6 6 0 0 1 3.364 10.008l-.18.185l-.048.041l-7.45 7.379a1 1 0 0 1-1.313.082l-.094-.082l-7.493-7.422A6 6 0 0 1 6.979 3.074"/></svg>';
             button.dataset.isSaved = 'true';
           } else {
             svgContainer.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>';
             button.dataset.isSaved = 'false';
           }
        }
      } catch (error) { console.error(error); } finally { button.disabled = false; }
    });
  }
});
</script>
{% endblock %}