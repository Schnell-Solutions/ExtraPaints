{% extends "base.html" %}
{% load static %}

{% block title %}{{ product.name }} | Extra Paints{% endblock %}

{% block content %}
<section class="py-12 md:py-16 bg-white">
  <div class="container mx-auto px-4 max-w-6xl">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 lg:gap-16">

      <div class="w-full h-[400px] md:h-[500px] lg:sticky lg:top-24">
        <div class="relative w-full h-full rounded overflow-hidden border border-gray-200">
          {% if product.main_image %}
            <img id="product-image" src="{{ product.main_image.url }}" alt="{{ product.name }}" class="w-full h-full object-cover">
          {% else %}
            <img id="product-image" src="https://placehold.co/600x600/f1f5f9/9ca3af?text={{ product.name|urlencode }}" alt="{{ product.name }}" class="w-full h-full object-cover">
          {% endif %}

        {% if user.is_authenticated %}
          <button
              class="save-product-btn absolute top-4 left-4 text-neutral-600 hover:text-red-500 transition-colors z-10"
              data-product-id="{{ product.id }}"
              data-is-saved="{{ is_saved|yesno:'true,false' }}"
            >
              <span class="heart-icon shadow">
                {% if is_saved %}
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="red">
                    <path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037.033l.034-.03a6 6 0 0 1 4.733-1.44l.246.036a6 6 0 0 1 3.364 10.008l-.18.185l-.048.041l-7.45 7.379a1 1 0 0 1-1.313.082l-.094-.082l-7.493-7.422A6 6 0 0 1 6.979 3.074"/>
                  </svg>
                {% else %}
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6.979 3.074a6 6 0 0 1 4.988 1.425l.037.033l.034-.03a6 6 0 0 1 4.733-1.44l.246.036a6 6 0 0 1 3.364 10.008l-.18.185l-.048.041l-7.45 7.379a1 1 0 0 1-1.313.082l-.094-.082l-7.493-7.422A6 6 0 0 1 6.979 3.074"/>
                  </svg>
                {% endif %}
              </span>
            </button>
        {% endif %}
          </div>
      </div>

      <div>
        <span class="text-sm text-gray-500 uppercase tracking-wider mb-2 block">
          {{ product.category.name|default:"General" }}
        </span>

        <h1 class="text-3xl md:text-4xl font-bold text-primary-900 mb-4">
          {{ product.name }}
        </h1>

        <p class="text-gray-600 mb-8 leading-relaxed">
          {{ product.description|default:"No description available." }}
        </p>

        <form id="add-to-quote-form" method="POST" action="{% url 'quote_add' %}">
          {% csrf_token %}
          <input type="hidden" name="product_id" value="{{ product.id }}">
          <input type="hidden" name="color_id" id="selected-color-id" value="">
          <input type="hidden" name="size_id" id="selected-size-id" value="">
          <input type="hidden" name="quantity" id="form-quantity" value="1">

          <div class="space-y-6 mb-10 border-t pt-6">

            <div>
              <h3 class="text-base font-semibold mb-3 text-primary-900">
                Select Color:
                <span id="selected-color-name" class="font-normal ml-2 text-gray-700"></span>
              </h3>
              <div id="color-selector" class="flex flex-wrap gap-2">
                {% for color in colors %}
                  <button
                    type="button" class="color-btn w-8 h-8 rounded-full border border-gray-300 transition-all hover:ring-2 hover:ring-primary-500 focus:outline-none disabled:opacity-30 disabled:cursor-not-allowed"
                    style="background-color: {{ color.hex_code|default:'#ccc' }}"
                    data-color-name="{{ color.name }}"
                    data-color-id="{{ color.id }}" title="{{ color.name }}"
                  ></button>
                {% empty %}
                  <p class="text-gray-500 text-sm">No colors available.</p>
                {% endfor %}
              </div>
            </div>

            <div>
              <h3 class="text-base font-semibold mb-3 text-primary-900">
                Select Size:
                <span id="selected-size-name" class="font-normal ml-2 text-gray-700"></span>
              </h3>
              <div id="size-selector" class="flex flex-wrap gap-2">
                  {% for size in sizes %}
                      <button
                        type="button" class="size-btn px-3 py-1 border rounded text-sm text-gray-700 focus:outline-none disabled:bg-gray-100 disabled:text-gray-400 disabled:border-gray-300 disabled:cursor-not-allowed"
                        data-size-name="{{ size.name }}"
                        data-size-id="{{ size.id }}" >
                        {{ size.name }}
                      </button>
                    {% empty %}
                      <p class="text-gray-500 text-sm">No sizes available.</p>
                    {% endfor %}
                  </div>
            </div>

            <div>
              <h3 class="text-base font-semibold mb-3 text-primary-900">Quantity:</h3>
              <input type="number" id="quantity-input" name="visible_quantity" value="1" min="1"
                     class="border rounded px-3 py-2 w-24 text-center focus:border-primary-500 focus:ring-1 focus:ring-primary-500">
            </div>

          </div>

          <div class="flex flex-col sm:flex-row gap-4">
            <button
              type="submit"
              id="add-to-quote-btn"
              class="w-full px-6 py-3 bg-primary-900 text-white rounded text-sm font-medium hover:bg-primary-700 transition-colors text-center disabled:bg-gray-400 disabled:cursor-not-allowed"
              disabled >
              <i data-lucide="plus" class="inline-block w-4 h-4 mr-1"></i>
              Add to Quote List
            </button>
          </div>

        </form> </div>
    </div>

    {% if product.safety_documents.exists %}
    <div class="mt-16 border-t pt-10">
      <h2 class="text-2xl font-semibold mb-6">Documents & Downloads</h2>
      <ul class="space-y-4">
        {% for doc in product.safety_documents.all %}
        <li class="flex items-center justify-between border-b pb-2">
          <div>
            <p class="font-medium">{{ doc.title }}</p>
            <p class="text-sm text-gray-500">{{ doc.get_doc_type_display }} â€” {{ doc.language|default:"N/A" }}</p>
          </div>
          <a href="{{ doc.file.url }}" target="_blank" class="text-primary-700 font-semibold hover:underline">Download</a>
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
  </div>
</section>

{{ color_availability_json|json_script:"color-availability-map" }}
{{ size_availability_json|json_script:"size-availability-map" }}

<script>
document.addEventListener("DOMContentLoaded", () => {
  // --- 1. GET ALL DOM ELEMENTS ---
  const colorAvailabilityMap = JSON.parse(document.getElementById("color-availability-map").textContent);
  const sizeAvailabilityMap = JSON.parse(document.getElementById("size-availability-map").textContent);

  const colorSelector = document.getElementById("color-selector");
  const sizeSelector = document.getElementById("size-selector");
  const colorBtns = document.querySelectorAll(".color-btn");
  const sizeBtns = document.querySelectorAll(".size-btn");

  const selectedColorNameEl = document.getElementById("selected-color-name");
  const selectedSizeNameEl = document.getElementById("selected-size-name");

  const quantityInput = document.getElementById("quantity-input");
  const addToQuoteForm = document.getElementById("add-to-quote-form");
  const addToQuoteBtn = document.getElementById("add-to-quote-btn");

  const selectedColorIdInput = document.getElementById("selected-color-id");
  const selectedSizeIdInput = document.getElementById("selected-size-id");
  const formQuantityInput = document.getElementById("form-quantity");

  const navbarQuoteCountDesktop = document.getElementById("navbar-quote-count-desktop");
  const navbarQuoteCountMobile = document.getElementById("navbar-quote-count-mobile");

  const saveProductBtn = document.querySelector(".save-product-btn");

  // --- 2. STATE VARIABLES ---
  let selectedColor = null;
  let selectedSize = null;
  let selectedColorId = null;
  let selectedSizeId = null;
  let selectedQuantity = parseInt(quantityInput.value, 10) || 1;

  // --- 3. HELPER FUNCTIONS ---
  function updateUI() {
    if (selectedColorId && selectedSizeId && selectedQuantity > 0) {
      addToQuoteBtn.disabled = false;
      addToQuoteBtn.innerHTML = `<i data-lucide="plus" class="inline-block w-4 h-4 mr-1"></i> Add to Quote List`;
    } else {
      addToQuoteBtn.disabled = true;
      let reason = "Select Color & Size";
      if (!selectedColorId && selectedSizeId) reason = "Select a Color";
      if (selectedColorId && !selectedSizeId) reason = "Select a Size";
      addToQuoteBtn.innerHTML = reason;
    }
    lucide.createIcons();
  }

  function updateSizeAvailability() {
    if (!selectedColor) {
      sizeBtns.forEach(btn => btn.disabled = false);
      return;
    }
    const availableSizes = colorAvailabilityMap[selectedColor] || [];
    sizeBtns.forEach(btn => {
      const sizeName = btn.dataset.sizeName;
      btn.disabled = !availableSizes.includes(sizeName);
    });
  }

  function updateColorAvailability() {
    if (!selectedSize) {
      colorBtns.forEach(btn => btn.disabled = false);
      return;
    }
    const availableColors = sizeAvailabilityMap[selectedSize] || [];
    colorBtns.forEach(btn => {
      const colorName = btn.dataset.colorName;
      btn.disabled = !availableColors.includes(colorName);
    });
  }

  // --- 4. EVENT LISTENERS ---
 colorSelector.addEventListener("click", (e) => {
  const btn = e.target.closest(".color-btn");
  if (!btn || btn.disabled) return;

  // Update selected color
  selectedColor = btn.dataset.colorName;
  selectedColorId = btn.dataset.colorId;

  selectedColorNameEl.textContent = selectedColor;
  selectedColorIdInput.value = selectedColorId;

  // Clear all previous highlights
  colorBtns.forEach(b => {
    b.classList.remove("ring-2", "ring-primary-500", "ring-offset-1");
    b.style.color = ""; // reset text color
  });

  // Highlight current selection
  btn.classList.add("ring-2", "ring-primary-500", "ring-offset-1");
  btn.style.color = "#fff"; // ensure text is visible if button has background

  updateSizeAvailability();

  // If selected size becomes unavailable, reset it
  if (selectedSize) {
    const selectedSizeBtn = document.querySelector(`.size-btn[data-size-name="${selectedSize}"]`);
    if (selectedSizeBtn && selectedSizeBtn.disabled) {
      selectedSize = null;
      selectedSizeId = null;
      selectedSizeNameEl.textContent = "";
      selectedSizeIdInput.value = "";
      sizeBtns.forEach(b => {
        b.classList.remove("bg-primary-900", "text-white", "border-primary-900");
        b.style.color = "";
      });
    }
  }

  updateUI();
});

sizeSelector.addEventListener("click", (e) => {
  const btn = e.target.closest(".size-btn");
  if (!btn || btn.disabled) return;

  // Update selected size
  selectedSize = btn.dataset.sizeName;
  selectedSizeId = btn.dataset.sizeId;

  selectedSizeNameEl.textContent = selectedSize;
  selectedSizeIdInput.value = selectedSizeId;

  // Clear all previous highlights
  sizeBtns.forEach(b => {
    b.classList.remove("bg-primary-900", "text-white", "border-primary-900");
    b.style.color = "";
  });

  // Highlight current selection
  btn.classList.add("bg-primary-900", "text-white", "border-primary-900");
  btn.style.color = "#fff"; // make sure text is visible

  updateColorAvailability();

  // If selected color becomes unavailable, reset it
  if (selectedColor) {
    const selectedColorBtn = document.querySelector(`.color-btn[data-color-name="${selectedColor}"]`);
    if (selectedColorBtn && selectedColorBtn.disabled) {
      selectedColor = null;
      selectedColorId = null;
      selectedColorNameEl.textContent = "";
      selectedColorIdInput.value = "";
      colorBtns.forEach(b => {
        b.classList.remove("ring-2", "ring-primary-500", "ring-offset-1");
        b.style.color = "";
      });
    }
  }

  updateUI();
});

  quantityInput.addEventListener("input", () => {
    let qty = parseInt(quantityInput.value, 10);
    if (isNaN(qty) || qty < 1) qty = 1;
    selectedQuantity = qty;
    formQuantityInput.value = selectedQuantity;
    updateUI();
  });

  // --- 5. AJAX FORM SUBMISSION ---
  addToQuoteForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(addToQuoteForm);
    const originalBtnHTML = addToQuoteBtn.innerHTML;

    addToQuoteBtn.disabled = true;
    addToQuoteBtn.innerHTML = `<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mx-auto"></div>`;

    try {
      const response = await fetch(addToQuoteForm.action, {
        method: "POST",
        body: formData,
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });

      const data = await response.json();

      if (data.status === "success") {
        addToQuoteBtn.innerHTML = `<i data-lucide="check" class="inline-block w-4 h-4 mr-1"></i> Added!`;
        lucide.createIcons();

        const count = data.quote_item_count;
        if (navbarQuoteCountDesktop) {
          navbarQuoteCountDesktop.textContent = count;
          navbarQuoteCountDesktop.classList.remove("hidden");
        }
        if (navbarQuoteCountMobile) {
          navbarQuoteCountMobile.textContent = count;
          navbarQuoteCountMobile.classList.remove("hidden");
        }
      } else {
        addToQuoteBtn.innerHTML = `Error!`;
      }
    } catch (error) {
      console.error("Fetch error:", error);
      addToQuoteBtn.innerHTML = `Error!`;
    }

    setTimeout(() => {
      addToQuoteBtn.disabled = false;
      addToQuoteBtn.innerHTML = originalBtnHTML;
      lucide.createIcons();
      updateUI();
    }, 2000);
  });

  // --- 6. SAVE TOGGLE ---
  if (saveProductBtn) {
    const saveToggleUrl = "{% url 'save_product_toggle' %}";
    // Get the CSRF token from the form that's already on the page
    const csrfToken = document.querySelector('form#add-to-quote-form [name=csrfmiddlewaretoken]').value;

    saveProductBtn.addEventListener('click', async () => {
      const productId = saveProductBtn.dataset.productId;
      if (!productId) return;

      saveProductBtn.disabled = true;

      try {
        const response = await fetch(saveToggleUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
          },
          body: `product_id=${productId}`
        });

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        const data = await response.json();

        if (data.status === 'success') {
          // --- THIS IS THE UPDATED PART ---
          const heartIcon = saveProductBtn.querySelector('.heart-icon');
          const svgElement = heartIcon.querySelector('svg'); // Find the <svg>

          if (svgElement) { // Check if we actually found it
            if (data.is_saved) {
              svgElement.setAttribute('fill', 'red'); // Set fill to red
              saveProductBtn.dataset.isSaved = 'true';
            } else {
              svgElement.setAttribute('fill', 'currentColor'); // Set fill to text color
              saveProductBtn.dataset.isSaved = 'false';
            }
          }
          // --- END OF UPDATED PART ---
        }
      } catch (error) {
        console.error('Failed to toggle save:', error);
      } finally {
        saveProductBtn.disabled = false; // Re-enable button
      }
    });
  }

  // --- 7. DEFAULT SELECTION (First color and size) ---
  if (colorBtns.length > 0) {
  colorBtns.forEach(b => {
    b.classList.remove("ring-2", "ring-primary-500", "ring-offset-1");
    b.style.color = "";
  });

  const firstColorBtn = colorBtns[0];
  selectedColor = firstColorBtn.dataset.colorName;
  selectedColorId = firstColorBtn.dataset.colorId;
  selectedColorNameEl.textContent = selectedColor;
  selectedColorIdInput.value = selectedColorId;

  firstColorBtn.classList.add("ring-2", "ring-primary-500", "ring-offset-1");
  firstColorBtn.style.color = "#fff"; // ensure text visible
}

// Auto-select first available size
if (sizeBtns.length > 0) {
  sizeBtns.forEach(b => {
    b.classList.remove("bg-primary-900", "text-white", "border-primary-900");
    b.style.color = "";
  });

  const firstSizeBtn = sizeBtns[0];
  selectedSize = firstSizeBtn.dataset.sizeName;
  selectedSizeId = firstSizeBtn.dataset.sizeId;
  selectedSizeNameEl.textContent = selectedSize;
  selectedSizeIdInput.value = selectedSizeId;

  firstSizeBtn.classList.add("bg-primary-900", "text-white", "border-primary-900");
  firstSizeBtn.style.color = "#fff"; // ensure text visible
}

// Run availability updates
updateSizeAvailability();
updateColorAvailability();

  // --- 8. INITIAL UI UPDATE ---
  updateUI();
});
</script>

{% endblock %}