{% extends "base.html" %}
{% load static %}

{% block title %}{{ color.name }} - Details{% endblock %}

{% block content %}
<section class="py-12 md:py-16 px-4 lg:px-12 bg-white">
  <div class="container mx-auto px-4 max-w-6xl">

    <div class="grid md:grid-cols-2 gap-12 lg:gap-16">

      {# --- LEFT COLUMN: Color Swatch & Image --- #}
      <div class="w-full relative">
        <div class="h-96 w-full rounded overflow-hidden border border-gray-200 mb-4 shadow-sm">
          {% if color.hex_code %}
            <div class="w-full h-full" style="background-color: {{ color.hex_code }}"></div>
          {% else %}
            <img src="{{ MEDIA_URL }}default.jpg" alt="Default image" class="w-full h-full object-cover">
          {% endif %}
        </div>

        {% if color.hex_code %}
        <div class="flex items-center gap-4 p-4 bg-gray-50 rounded border border-gray-200">
          <div class="w-16 h-16 rounded-md shadow-sm border border-gray-300" style="background-color: {{ color.hex_code }}"></div>
          <div>
            <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Hex Color</p>
            <p class="text-lg font-mono font-semibold text-gray-900">{{ color.hex_code }}</p>
          </div>
        </div>
        {% endif %}

        {# --- SAVE COLOR BUTTON --- #}
        {% if user.is_authenticated %}
          <button
              class="save-color-btn absolute top-6 right-6 z-10 p-3 bg-white rounded-full shadow-md hover:shadow-lg transition-all duration-300 focus:outline-none group"
              data-color-id="{{ color.id }}"
              data-is-saved="{{ is_saved|yesno:'true,false' }}"
              data-url="{% url 'save_color_toggle' %}"
              title="Save Color"
          >
              <span class="heart-icon block transition-transform duration-300 group-hover:scale-110">
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 transition-colors duration-300" viewBox="0 0 24 24"
                       fill="{% if is_saved %}red{% else %}none{% endif %}"
                       stroke="{% if is_saved %}red{% else %}currentColor{% endif %}"
                       stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                  </svg>
              </span>
          </button>
        {% endif %}
      </div>

      {# --- RIGHT COLUMN: Color Details --- #}
      <div>
        <div class="mb-2">
            {% if color.collection %}
            <span class="inline-block py-1 px-3 rounded-full bg-primary-100 text-primary-800 text-xs font-semibold tracking-wide uppercase">
                {{ color.collection.name }}
            </span>
            {% endif %}
        </div>
        <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4 tracking-tight">{{ color.name }}</h1>
        <p class="text-lg text-gray-600 mb-8 leading-relaxed">{{ color.description|default:"A versatile and timeless color, perfect for adding character to any space." }}</p>

        <div class="bg-gray-50 rounded-xl p-6 mb-8 border border-gray-200">
          <h3 class="text-sm font-semibold text-gray-900 uppercase tracking-wider mb-4">Technical Details</h3>
          <dl class="grid grid-cols-2 gap-x-6 gap-y-4 text-sm">
            <div>
              <dt class="font-medium text-gray-500">Color Code</dt>
              <dd class="mt-1 font-semibold text-gray-900">{{ color.code }}</dd>
            </div>
            {% if color.lrv %}
            <div>
              <dt class="font-medium text-gray-500">LRV</dt>
              <dd class="mt-1 font-semibold text-gray-900">{{ color.lrv }}</dd>
            </div>
            {% endif %}
            {% if color.rgb_value %}
            <div>
              <dt class="font-medium text-gray-500">RGB</dt>
              <dd class="mt-1 font-mono text-gray-900">{{ color.rgb_value }}</dd>
            </div>
            {% endif %}
            {% if color.undertone %}
            <div>
              <dt class="font-medium text-gray-500">Undertone</dt>
              <dd class="mt-1 font-semibold text-gray-900 capitalize">{{ color.get_undertone_display }}</dd>
            </div>
            {% endif %}
          </dl>
        </div>

        <button
          type="button"
          id="open-drawer-btn"
          class="w-full bg-primary-900 inline-flex items-center justify-center px-8 py-4 border border-transparent text-base font-medium rounded-md text-white hover:bg-primary-900/80 md:py-4 md:text-lg md:px-10 transition-colors duration-300"
        >
          <i data-lucide="shopping-bag" class="w-5 h-5 mr-3"></i>
          See Products in {{ color.name }}
        </button>
      </div>
    </div>

    {# --- ADDITIONAL DETAILS: Finishes & Surfaces --- #}
    <div class="mt-16 pt-10 border-t border-gray-200 grid md:grid-cols-2 gap-12">
        {% if color.available_finishes.exists %}
        <div>
          <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <i data-lucide="droplet" class="w-5 h-5 mr-2 text-primary-500"></i>
              Available Finishes
          </h3>
          <ul class="flex flex-wrap gap-2">
            {% for f in color.available_finishes.all %}
              <li class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-white border border-gray-300 text-gray-700">
                {{ f.name }}
              </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        {% if color.recommended_surfaces.exists %}
        <div>
          <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
              <i data-lucide="layers" class="w-5 h-5 mr-2 text-primary-500"></i>
              Ideal For
          </h3>
          <ul class="flex flex-wrap gap-2">
            {% for s in color.recommended_surfaces.all %}
              <li class="inline-flex items-center px-3 py-1.5 rounded-full text-sm font-medium bg-white border border-gray-300 text-gray-700">
                {{ s.name }}
              </li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}
    </div>

    {# --- INSPIRATION GALLERY --- #}
    {% if color.inspiration_images.exists %}
      <div class="mt-16 pt-12 border-t border-gray-200">
        <div class="text-center mb-10">
            <h2 class="text-3xl font-bold text-gray-900">Inspiration Gallery</h2>
            <p class="mt-2 text-lg text-gray-600">See how {{ color.name }} looks in real spaces.</p>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          {% for img in color.inspiration_images.all %}
              <div class="group relative overflow-hidden rounded-md hover:shadow transition-all duration-300">
                  {% if img.image %}
                    <img src="{{ img.image.url }}"
                         alt="{{ img.caption|default:color.name }}"
                         class="w-full h-72 object-cover transform group-hover:scale-105 transition-transform duration-500">
                  {% else %}
                    <div class="w-full h-72 bg-gray-100 flex items-center justify-center text-gray-400">
                        <i data-lucide="image-off" class="w-12 h-12"></i>
                    </div>
                  {% endif %}
                {% if img.caption %}
                  <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-transparent to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-end">
                      <p class="text-white p-6 font-medium text-sm">{{ img.caption }}</p>
                  </div>
                {% endif %}
              </div>
            {% endfor %}
        </div>
      </div>
    {% endif %}

  </div>
</section>

{# --- SHOP DRAWER --- #}
<div id="drawer-overlay"
     class="fixed inset-0 bg-neutral-900/60 z-[998] hidden transition-opacity duration-300 opacity-0 backdrop-blur-sm">
</div>

<div id="drawer-panel"
     class="fixed top-0 right-0 h-full w-full max-w-md bg-white z-[999] shadow-2xl transform translate-x-full transition-transform duration-300 ease-out flex flex-col">

    {# Drawer Header #}
    <div class="flex items-center justify-between px-6 py-4 border-b border-neutral-200 bg-white">
      <h2 class="text-xl font-bold text-neutral-900">
        Shop <span class="text-primary-700">{{ color.name }}</span>
      </h2>
      <button id="close-drawer-btn"
              class="p-2 text-neutral-400 bg-transparent rounded-full hover:bg-neutral-100 hover:text-neutral-700 transition-colors focus:outline-none"
              aria-label="Close drawer">
        <i data-lucide="x" class="w-6 h-6"></i>
      </button>
    </div>

    {# Drawer Filters #}
    <div class="px-6 py-4 border-b border-neutral-200 bg-neutral-50/80">
      <label for="category-filter" class="block text-sm font-semibold text-neutral-700 mb-2">
        Filter Products
      </label>
      <div class="relative">
          <select id="category-filter"
                  class="block w-full pl-4 pr-10 py-2.5 text-sm border border-neutral-300 rounded-lg bg-white text-neutral-900 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 appearance-none cursor-pointer">
            <option value="">All Categories</option>
            {% for category in shop_categories %}
              <option value="{{ category.slug }}">{{ category.name }}</option>
            {% endfor %}
          </select>
          <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-neutral-500">
            <i data-lucide="chevron-down" class="w-4 h-4"></i>
          </div>
      </div>
    </div>

    {# Drawer Content Area #}
    <div id="drawer-content" class="flex-1 overflow-y-auto p-6 relative bg-neutral-100">

        {# Loader: Covers content area when active #}
        <div id="drawer-loader"
             class="absolute inset-0 flex flex-col items-center justify-center bg-neutral-100/80 backdrop-blur-[2px] z-10 hidden">
            <div class="animate-spin text-primary-600 mb-3">
               <i data-lucide="loader-2" class="w-10 h-10"></i>
            </div>
            <p class="text-sm font-medium text-neutral-600">Loading products...</p>
        </div>

        {# Product List Container #}
        <ul id="drawer-product-list" class="space-y-4">
            </ul>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // --- GLOBAL CONSTANTS & ELEMENTS ---
  const COLOR_ID = {{ color.id }};
  const URLS = {
      quoteAdd: "{% url 'quote_add' %}",
      products: `{% url 'ajax_get_color_products' color.id %}`,
      saveProduct: "{% url 'save_product_toggle' %}"
  };
  // Safe CSRF Retrieval
  const getCsrfToken = () => document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';

  // Drawer Elements
  const drawer = {
      openBtn: document.getElementById('open-drawer-btn'),
      closeBtn: document.getElementById('close-drawer-btn'),
      overlay: document.getElementById('drawer-overlay'),
      panel: document.getElementById('drawer-panel'),
      filter: document.getElementById('category-filter'),
      list: document.getElementById('drawer-product-list'),
      loader: document.getElementById('drawer-loader')
  };

  // Navbar Counters (for updating after add-to-quote)
  const navbarCounts = {
      desktop: document.getElementById("navbar-quote-count-desktop"),
      mobile: document.getElementById("navbar-quote-count-mobile")
  };

  // --- DRAWER STATE CONTROL ---
  function toggleDrawer(isOpen) {
      if (isOpen) {
          drawer.overlay.classList.remove('hidden');
          // slight delay to allow 'hidden' removal to take effect before opacity animates
          setTimeout(() => {
               drawer.overlay.classList.add('opacity-100');
               drawer.panel.classList.remove('translate-x-full');
          }, 10);
          document.body.style.overflow = 'hidden';
          // Load products if list is empty
          if (drawer.list.innerHTML.trim() === '') loadProducts();
      } else {
          drawer.overlay.classList.remove('opacity-100');
          drawer.panel.classList.add('translate-x-full');
          document.body.style.overflow = '';
          setTimeout(() => {
              drawer.overlay.classList.add('hidden');
          }, 300);
      }
  }

  // Drawer Event Listeners
  if (drawer.openBtn) drawer.openBtn.addEventListener('click', () => toggleDrawer(true));
  if (drawer.closeBtn) drawer.closeBtn.addEventListener('click', () => toggleDrawer(false));
  if (drawer.overlay) drawer.overlay.addEventListener('click', () => toggleDrawer(false));

  // --- PRODUCT LOADING ---
  if (drawer.filter) drawer.filter.addEventListener('change', loadProducts);

  async function loadProducts() {
      drawer.loader.style.display = 'block';
      drawer.list.innerHTML = ''; // Clear list

      const url = new URL(URLS.products, window.location.origin);
      if (drawer.filter && drawer.filter.value) {
          url.searchParams.append('category', drawer.filter.value);
      }

      try {
          const res = await fetch(url);
          if (!res.ok) throw new Error('Network error');
          const products = await res.json();

          drawer.loader.style.display = 'none';

          if (products.length === 0) {
              drawer.list.innerHTML = '<p class="text-gray-500 text-center py-8">No products found for this selection.</p>';
          } else {
              // Use map().join('') for efficient DOM insertion
              drawer.list.innerHTML = products.map(product => createProductCard(product)).join('');
          }

          // Re-initialize icons for new content
          if (typeof lucide !== 'undefined') lucide.createIcons();

      } catch (error) {
          console.error("Load error:", error);
          drawer.loader.style.display = 'none';
          drawer.list.innerHTML = '<p class="text-red-500 text-center py-8">Failed to load products.</p>';
      }
  }

  // --- HTML TEMPLATE BUILDER ---
  function createProductCard(product) {
      // Handle sizes safely
      const sizes = Array.isArray(product.sizes) ? product.sizes : [];
      const hasSizes = sizes.length > 0;

      let sizeOptions = '<option value="">Standard</option>';
      let defaultSizeId = '';

      if (hasSizes) {
           sizeOptions = sizes.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
           defaultSizeId = sizes[0].id;
      }

      // Determine save button state
      const saveClass = product.is_saved ? 'text-red-500 border-red-200 bg-red-50' : 'text-gray-400 border-gray-300 hover:bg-gray-50';
      const heartFill = product.is_saved ? 'currentColor' : 'none';

      // RETURN HTML STRING
      // Added explicit 'bg-white', 'text-gray-900' etc. to ensure visibility
      return `
        <div class="product-card-drawer bg-white border border-gray-200 rounded-lg p-4 shadow-sm transition-all mb-4" data-product-id="${product.id}">
            <div class="flex gap-4">
              <div class="w-20 h-20 flex-shrink-0 bg-gray-100 rounded-md border border-gray-200 overflow-hidden">
                  <img src="${product.image_url}" alt="${product.name}" class="w-full h-full object-contain p-1 mix-blend-multiply">
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-semibold text-gray-900 leading-tight">${product.name}</p>
                <p class="text-xs text-primary-700 font-medium uppercase tracking-wider mb-2">${product.full_category || product.category}</p>

                <div class="mt-2">
                    ${hasSizes ? `
                    <label class="text-xs font-medium text-gray-500 mb-1 block">Select Size:</label>
                    <select class="drawer-size-select w-full border border-gray-300 bg-white text-gray-900 rounded text-sm py-1.5 px-2 focus:ring-1 focus:ring-primary-500 focus:border-primary-500">
                      ${sizeOptions}
                    </select>
                    ` : ''}
                  </div>
              </div>
            </div>

            <div class="flex gap-2 mt-4 pt-3 border-t border-gray-100">
              <a href="${product.url}" class="flex-1 px-3 py-2 border border-gray-300 text-gray-700 bg-white rounded-md text-xs font-medium hover:bg-gray-50 text-center transition-colors">
                View Details
              </a>
              <button
                type="button"
                class="drawer-add-to-quote-btn flex-1 px-3 py-2 bg-primary-900 text-white rounded-md text-xs font-medium hover:bg-primary-800 text-center transition-colors"
                data-preselected-size="${defaultSizeId}">
                Add to Quote
              </button>
              <button
                type="button"
                class="js-save-product-toggle p-2 border rounded-md transition-colors ${saveClass}"
                data-product-id="${product.id}"
                data-is-saved="${product.is_saved}">
                <i data-lucide="heart" class="w-5 h-5" fill="${heartFill}"></i>
              </button>
            </div>
        </div>
      `;
  }

  // --- EVENT DELEGATION (Handles Clicks in Drawer) ---
  drawer.list.addEventListener('click', async (e) => {
      // 1. HANDLE: Add to Quote
      const addBtn = e.target.closest('.drawer-add-to-quote-btn');
      if (addBtn) {
          e.preventDefault();
          await handleAddToQuote(addBtn);
          return;
      }

      // 2. HANDLE: Save Product Toggle
      const saveBtn = e.target.closest('.js-save-product-toggle');
      if (saveBtn) {
          e.preventDefault();
          await handleSaveProduct(saveBtn);
          return;
      }
  });

  // --- ACTION HANDLERS ---
  async function handleAddToQuote(btn) {
      const card = btn.closest('.product-card-drawer');
      const productId = card.dataset.productId;
      const sizeSelect = card.querySelector('.drawer-size-select');
      // Use select value if present, else fallback to data attribute (for single-size items)
      const sizeId = sizeSelect ? sizeSelect.value : btn.dataset.preselectedSize;

      if (sizeSelect && !sizeId) {
           sizeSelect.classList.add('border-red-500', 'ring-1', 'ring-red-500');
           setTimeout(() => sizeSelect.classList.remove('border-red-500', 'ring-1', 'ring-red-500'), 2000);
           return;
      }

      // UI Loading State
      const originalHTML = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4 mx-auto"></i>';
      if (typeof lucide !== 'undefined') lucide.createIcons();

      try {
          const body = new URLSearchParams({
              product_id: productId,
              color_id: COLOR_ID,
              quantity: 1,
              csrfmiddlewaretoken: getCsrfToken()
          });
          if (sizeId) body.append('size_id', sizeId);

          const res = await fetch(URLS.quoteAdd, {
              method: "POST",
              headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-Requested-With': 'XMLHttpRequest' },
              body
          });
          const data = await res.json();

          if (data.status === "success") {
              btn.innerHTML = 'Added!';
              btn.classList.replace('bg-primary-900', 'bg-green-600');

              // Update navbar counters
              [navbarCounts.desktop, navbarCounts.mobile].forEach(el => {
                  if (el) { el.textContent = data.quote_item_count; el.classList.remove('hidden'); }
              });
          } else {
              throw new Error(data.message);
          }
      } catch (error) {
          btn.innerHTML = 'Error';
          btn.classList.replace('bg-primary-900', 'bg-red-600');
      } finally {
          // Reset button after 2 seconds
          setTimeout(() => {
              btn.disabled = false;
              btn.innerHTML = originalHTML;
              btn.classList.remove('bg-green-600', 'bg-red-600');
              btn.classList.add('bg-primary-900');
          }, 2000);
      }
  }

  async function handleSaveProduct(btn) {
      const productId = btn.dataset.productId;
      btn.disabled = true;

      try {
          const res = await fetch(URLS.saveProduct, {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': getCsrfToken(), 'X-Requested-With': 'XMLHttpRequest' },
              body: `product_id=${productId}`
          });
          const data = await res.json();

          if (data.status === 'success') {
              const isSaved = data.is_saved;
              btn.dataset.isSaved = isSaved;

              // Toggle styles based on new state
              if (isSaved) {
                  btn.classList.add('text-red-500', 'border-red-200', 'bg-red-50');
                  btn.classList.remove('text-gray-400', 'border-gray-300', 'hover:bg-gray-50');
                  btn.querySelector('i').setAttribute('fill', 'currentColor');
              } else {
                  btn.classList.remove('text-red-500', 'border-red-200', 'bg-red-50');
                  btn.classList.add('text-gray-400', 'border-gray-300', 'hover:bg-gray-50');
                  btn.querySelector('i').setAttribute('fill', 'none');
              }
          }
      } catch (error) {
          console.error('Save toggle failed:', error);
      } finally {
          btn.disabled = false;
      }
  }

  // --- MAIN PAGE SAVE COLOR BUTTON ---
  const saveColorBtn = document.querySelector('.save-color-btn');
  if (saveColorBtn) {
      saveColorBtn.addEventListener('click', async () => {
          saveColorBtn.disabled = true;
          try {
              const res = await fetch(saveColorBtn.dataset.url, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'X-CSRFToken': getCsrfToken(), 'X-Requested-With': 'XMLHttpRequest' },
                  body: `color_id=${COLOR_ID}`
              });
              const data = await res.json();
              if (data.status === 'success') {
                  const isSaved = data.is_saved;
                  saveColorBtn.dataset.isSaved = isSaved;
                  const svg = saveColorBtn.querySelector('svg');
                  if (isSaved) {
                       svg.setAttribute('fill', 'red');
                       svg.setAttribute('stroke', 'red');
                  } else {
                       svg.setAttribute('fill', 'none');
                       svg.setAttribute('stroke', 'currentColor');
                  }
              }
          } catch (err) { console.error(err); }
          finally { saveColorBtn.disabled = false; }
      });
  }
});
</script>
{% endblock %}